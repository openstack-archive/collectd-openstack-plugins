#!/bin/bash
#
# common functions for collectd ceilometer plugin
# -----------------------------------------------

# start/stop service
#
function start_collectd {
    if [ -e /usr/lib/systemd/system/collectd.service ] || [ -e /etc/init.d/collectd ]; then
        sudo service collectd start
    fi
}

function stop_collectd {
    if [ -e /usr/lib/systemd/system/collectd.service ] || [ -e /etc/init.d/collectd ]; then
        sudo service collectd stop
    fi
}

function install_service_file {
    # Systemd
    #if [[ -d "/etc/systemd/system" ]]; then

    #    sudo wget  https://raw.githubusercontent.com/martin-magakian/collectd-script/master/collectd.service -O /etc/systemd/system/collectd.service
    #    # Adjust file content
    #    sed "s#/opt/collectd#$COLLECTD_DIR#g" -i /etc/systemd/system/collectd.service
    #else
        local service_file=/etc/init.d/collectd
        # sysvinit
        sudo -EH wget https://raw.githubusercontent.com/astro/collectd/master/debian/collectd.init.d -O /etc/init.d/collectd

        # adjust conf file
        #local service_dir=/etc/init.d/
        # Add collectd dir to PATH
        sudo sed 's#PATH=.*$#&:'"$COLLECTD_DIR"'#' -i /etc/init.d/collectd
        # Point DAEMON, SCRIPTNAME, CONFDIRs at $COLLECTD_DIR/{etc/collectd.conf,sbin/collectd}
        sudo sed 's#DAEMON=/#DAEMON='"$COLLECTD_DIR"'#g' -i /etc/init.d/collectd
        sudo sed 's#SCRIPTNAME=/#SCRIPTNAME='"$COLLECTD_DIR"'#g' -i /etc/init.d/collectd
        sudo sed 's#CONFIGDIR=/#CONFIGDIR='"$COLLECTD_DIR"'#g' -i /etc/init.d/collectd
        sudo sed 's#FALLBACKCONF=/#FALLBACKCONF='"$COLLECTD_DIR"'#g' -i /etc/init.d/collectd

        sudo chmod +x /etc/init.d/collectd

    #fi
}

function build_collectd {
    git_clone $COLLECTD_REPO $COLLECTD_DIR $COLLECTD_BRANCH
    pushd $COLLECTD_DIR
    . build.sh
    ./configure --enable-python --enable-debug \
       --enable-logging --enable-syslog \
       --prefix=$COLLECTD_DIR
    sudo make all install
    popd

    install_service_file

}

# install collectd
function install_collectd {
    if [[ "$COLLECTD_INSTALL" == True  ]]; then
        if [[ "$COLLECTD_INSTALL_TYPE" == "source" ]]; then
            build_collectd
        else # if install type is binary
            if is_fedora || is_ubuntu; then
                install_package collectd
            else
                die $LINENO "No support for collectd on this platform"
            fi
        fi
    fi
}

# Add conf file for plugin
function adapt_collectd_conf {
if [ ! -d "$COLLECTD_CONF_DIR" ]; then
        sudo mkdir "$COLLECTD_CONF_DIR"
fi
cat << EOF | sudo tee $COLLECTD_CONF_DIR/collectd-ceilometer-plugin.conf
<LoadPlugin python>
  Globals true
</LoadPlugin>

<Plugin python>
    ModulePath "$COLLECTD_CEILOMETER_DIR"
    LogTraces true
    Interactive false
    Import "collectd_ceilometer.plugin"

    <Module "collectd_ceilometer.plugin">

        # Verbosity 1|0
        #VERBOSE 0

        # Batch size
        BATCH_SIZE "$COLLECTD_BATCH_SIZE"

        # Service endpoint addresses
        OS_AUTH_URL "$OS_AUTH_URL"

        # Ceilometer address
        #CEILOMETER_ENDPOINT
        CEILOMETER_URL_TYPE "$CEILOMETER_URL_TYPE"

        # Ceilometer timeout in ms
        CEILOMETER_TIMEOUT "$CEILOMETER_TIMEOUT"

        # # Ceilometer user creds
        OS_USERNAME "$OS_USERNAME"
        OS_PASSWORD "$OS_PASSWORD"
        OS_TENANT_NAME "service"

    </Module>
</Plugin>
EOF

}


# remove plugin conf file
function restore_collectd_conf {

    if [ -f '$COLLECTD_CONF_DIR/collectd-ceilometer-plugin.conf' ]; then
        sudo rm -f $COLLECTD_CONF_DIR/collectd-ceilometer-plugin.conf
    fi

}
